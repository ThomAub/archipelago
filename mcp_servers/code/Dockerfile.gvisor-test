# Dockerfile for testing LD_PRELOAD sandbox with gVisor
#
# This container:
# 1. Compiles the sandbox_fs.so library
# 2. Sets up test directories (including blocked paths)
# 3. Runs integration tests that exercise the real sandbox

FROM python:3.13-slim

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libc-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Python test dependencies
RUN pip install --no-cache-dir pytest pytest-asyncio loguru

# Create application directory structure
WORKDIR /app

# Copy source code
COPY mcp_servers/code_execution_server/ /app/

# Compile the sandbox library (to /app/lib/ for consistency with production)
RUN mkdir -p /app/lib && \
    gcc -shared -fPIC -O2 -o /app/lib/sandbox_fs.so /app/sandbox_fs.c -ldl -lpthread

# Create test directories
# /app is our blocked path (already exists as WORKDIR)
# Create /.apps_data as another blocked path
RUN mkdir -p /.apps_data && \
    echo "secret data" > /.apps_data/secret.txt && \
    echo "app secret" > /app/secret.txt

# Create workspace directory for allowed operations
RUN mkdir -p /filesystem && \
    chmod 777 /filesystem

# Set environment variables for tests
ENV SANDBOX_LIBRARY_PATH=/app/lib/sandbox_fs.so
ENV APP_FS_ROOT=/filesystem
ENV PYTHONPATH=/app

# Run the gVisor-specific integration tests
CMD ["pytest", "-v", "tests/test_gvisor_sandbox.py", "-s"]
